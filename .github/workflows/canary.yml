name: Canary Release

on:
  pull_request:
    branches:
      - main
      - master
  push:
    branches-ignore:
      - main
      - master

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  canary:
    name: Canary Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Instalar deps
        run: npm ci

      - name: Testes
        run: npm test

      - name: Build
        run: npm run build

      - name: Pre mode canary
        run: |
          if [ ! -f .changeset/pre.json ]; then
            npx changeset pre enter canary
          else
            echo "J√° est√° em pre mode, pulando changeset pre enter"
          fi

      - name: Bump vers√£o canary
        run: npx changeset version

      - name: Hash na vers√£o canary
        run: |
          HASH=$(git rev-parse --short HEAD)
          PKG_VERSION=$(node -p "require('./package.json').version")
          if [[ "$PKG_VERSION" == *canary* ]]; then
            NEW_VERSION="${PKG_VERSION}+${HASH}"
            node -e "const fs = require('fs'); const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8')); pkg.version = '$NEW_VERSION'; fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');"
            echo "Vers√£o canary ajustada para: $NEW_VERSION"
          fi

      - name: Verificar canary
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          if [[ "$PKG_VERSION" != *canary* ]]; then
            echo "A vers√£o $PKG_VERSION n√£o √© canary. Cancelando publica√ß√£o."
            exit 0
          fi

      - name: Checar vers√£o npm
        id: canary_exists
        run: |
          PKG_NAME=$(node -p "require('./package.json').name")
          PKG_VERSION=$(node -p "require('./package.json').version")
          EXISTE=$(npm view "$PKG_NAME@$PKG_VERSION" version || echo "")
          if [ "$EXISTE" = "$PKG_VERSION" ]; then
            echo "A vers√£o $PKG_VERSION j√° existe no npm. Pulando publica√ß√£o."
            echo "publish=false" >> $GITHUB_OUTPUT
          else
            echo "Vers√£o $PKG_VERSION ainda n√£o publicada."
            echo "publish=true" >> $GITHUB_OUTPUT
          fi

      - name: Publicar npm
        if: steps.canary_exists.outputs.publish == 'true'
        run: |
          # Publica apenas no npmjs, pois o npm n√£o aceita sufixo +hash e o GitHub Packages n√£o √© utilizado
          npm publish --tag canary --access public || {
            if grep -q "previously published versions" /home/runner/.npm/_logs/*-debug-0.log 2>/dev/null; then
              echo "Vers√£o j√° publicada por outro workflow. Ignorando erro.";
              exit 0;
            else
              echo "Erro inesperado ao publicar.";
              exit 1;
            fi
          }
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # Removido o passo de publica√ß√£o no GitHub Packages pois n√£o √© necess√°rio

      - name: Sair pre mode
        if: always()
        run: npx changeset pre exit

      - name: Comentar PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const pkg = require('./package.json');
            const version = pkg.version;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üöÄ Canary publicado no npm:\n- **npm:** \`npm install ${pkg.name}@${version}\`\n> Vers√£o: \`${version}\`\n\nObs: O pacote canary √© publicado apenas no npmjs. O sufixo '+hash' n√£o √© aceito pelo npmjs, ent√£o a vers√£o publicada ser√° sempre no formato x.y.z-canary.n.`
            }); 