name: Canary Release

on:
  pull_request:
    branches:
      - main
      - master
  push:
    branches-ignore:
      - main
      - master

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  canary:
    name: Canary Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install Dependencies
        run: npm ci

      - name: Run Tests
        run: npm test

      - name: Build
        run: npm run build

      - name: Enter pre mode for canary
        run: |
          if [ ! -f .changeset/pre.json ]; then
            npx changeset pre enter canary
          else
            echo "Já está em pre mode, pulando changeset pre enter"
          fi

      - name: Bump canary version
        run: npx changeset version

      - name: Adicionar hash do commit na versão canary
        run: |
          HASH=$(git rev-parse --short HEAD)
          PKG_VERSION=$(node -p "require('./package.json').version")
          # Só altera se for canary
          if [[ "$PKG_VERSION" == *canary* ]]; then
            NEW_VERSION=$(echo $PKG_VERSION | sed "s/\(canary\)\(\.[0-9]*\)\?$/canary.$HASH/")
            node -e "const fs = require('fs'); const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8')); pkg.version = '$NEW_VERSION'; fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');"
            echo "Versão canary ajustada para: $NEW_VERSION"
          fi

      - name: Commit canary version bump
        if: github.event_name == 'push'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git commit -m "chore: canary version bump [skip ci]" || echo "No changes to commit"
          git pull --rebase origin ${GITHUB_REF_NAME} || echo "No remote changes to rebase"
          git push origin HEAD:${GITHUB_REF_NAME} || echo "No changes to push"

      - name: Checar se versão canary já existe no npm
        id: canary_exists
        run: |
          PKG_NAME=$(node -p "require('./package.json').name")
          PKG_VERSION=$(node -p "require('./package.json').version")
          EXISTE=$(npm view "$PKG_NAME@$PKG_VERSION" version || echo "")
          if [ "$EXISTE" = "$PKG_VERSION" ]; then
            echo "A versão $PKG_VERSION já existe no npm. Pulando publicação."
            echo "publish=false" >> $GITHUB_OUTPUT
          else
            echo "Versão $PKG_VERSION ainda não publicada."
            echo "publish=true" >> $GITHUB_OUTPUT
          fi

      - name: Publish canary to npm
        if: steps.canary_exists.outputs.publish == 'true'
        run: |
          npm publish --tag canary --access public || {
            if grep -q "previously published versions" /home/runner/.npm/_logs/*-debug-0.log 2>/dev/null; then
              echo "Versão já publicada por outro workflow. Ignorando erro.";
              exit 0;
            else
              echo "Erro inesperado ao publicar.";
              exit 1;
            fi
          }
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Publish canary to GitHub Packages
        if: steps.canary_exists.outputs.publish == 'true'
        run: |
          npm publish --tag canary --registry=https://npm.pkg.github.com || {
            if grep -q "previously published versions" /home/runner/.npm/_logs/*-debug-0.log 2>/dev/null; then
              echo "Versão já publicada por outro workflow (GitHub Packages). Ignorando erro.";
              exit 0;
            else
              echo "Erro inesperado ao publicar no GitHub Packages.";
              exit 1;
            fi
          }
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Exit pre mode for canary
        if: always()
        run: npx changeset pre exit

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const pkg = require('./package.json');
            const version = pkg.version;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `🚀 Canary publicado: \n- **npm:** \`npm install ${pkg.name}@${version}\`\n- **GitHub Packages:** \`npm install @gilbert_oliveira/commit-wizard@${version} --registry=https://npm.pkg.github.com\`\n> Versão: \`${version}\``
            }); 