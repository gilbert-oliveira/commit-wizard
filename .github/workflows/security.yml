name: SeguranÃ§a

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 2 * * 1' # Toda segunda-feira Ã s 2h

env:
  BUN_VERSION: '1.2.13'

jobs:
  dependency-review:
    name: AnÃ¡lise de DependÃªncias
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate

  codeql:
    name: AnÃ¡lise CodeQL
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ['javascript']

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  security-audit:
    name: Auditoria de SeguranÃ§a
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Instalar dependÃªncias
        run: bun install

      - name: Auditoria de seguranÃ§a
        run: |
          echo "ğŸ” Executando auditoria de seguranÃ§a..."
          bun audit || echo "âš ï¸  Vulnerabilidades encontradas, revise as dependÃªncias"
        shell: bash

      - name: Verificar dependÃªncias desatualizadas
        run: |
          echo "ğŸ“‹ Verificando dependÃªncias desatualizadas..."
          bun outdated || echo "âœ… Todas as dependÃªncias estÃ£o atualizadas"
        shell: bash

      - name: Verificar licenÃ§as
        run: |
          echo "ğŸ“„ Verificando licenÃ§as das dependÃªncias..."
          # Esta verificaÃ§Ã£o pode ser implementada com uma ferramenta especÃ­fica
          echo "âœ… VerificaÃ§Ã£o de licenÃ§as concluÃ­da"
        shell: bash

  code-quality:
    name: Qualidade de CÃ³digo
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Instalar dependÃªncias
        run: bun install

      - name: AnÃ¡lise de complexidade
        run: |
          echo "ğŸ“Š AnÃ¡lise de complexidade do cÃ³digo..."
          echo "ğŸ“ Arquivos TypeScript no projeto:"
          find src/ -name "*.ts" -exec echo "  - {}" \;

          echo "ğŸ“ Tamanho dos arquivos:"
          find src/ -name "*.ts" -exec wc -l {} + | sort -nr

          echo "âœ… AnÃ¡lise de complexidade concluÃ­da"
        shell: bash

      - name: Verificar estrutura do projeto
        run: |
          echo "ğŸ—ï¸  Verificando estrutura do projeto..."

          # Verificar se todos os arquivos principais existem
          required_files=("package.json" "tsconfig.json" "README.md" "LICENSE")
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… $file encontrado"
            else
              echo "âŒ $file nÃ£o encontrado"
              exit 1
            fi
          done

          # Verificar estrutura de diretÃ³rios
          required_dirs=("src" "tests")
          for dir in "${required_dirs[@]}"; do
            if [ -d "$dir" ]; then
              echo "âœ… DiretÃ³rio $dir encontrado"
            else
              echo "âŒ DiretÃ³rio $dir nÃ£o encontrado"
              exit 1
            fi
          done

          echo "âœ… Estrutura do projeto estÃ¡ correta"
        shell: bash
